
<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard FIDC NX Boats</title>

<!-- Chart.js + DataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
  :root{
    --azul-muito-escuro:#004065; /* HEX1 */
    --azul-escuro:#286DAC;       /* HEX2 */
    --azul-claro:#A7CCEB;        /* HEX3 */
    --azul-destaque:#118DFF;     /* HEX4 */
    --cinza-mto-escuro:#666666;  /* HEX5 */
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#eef4fb;color:#0f172a}
  header{
    background:var(--azul-muito-escuro);
    color:#fff;
    padding:12px 18px;
    font-weight:900;
    font-size:28px;
    text-align:center;
    letter-spacing:.3px
  }
  .wrap{max-width:1200px;margin:18px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .band{background:var(--azul-escuro);color:#fff;border-radius:10px;padding:8px 10px;font-weight:900;margin:-6px -6px 12px;letter-spacing:.3px}
  .kpi-valor{font-size:32px;font-weight:900;margin:6px 0;color:#000}
  .kpi-valor.center{text-align:center}
  .sub-title{margin:12px 0 4px;font-weight:800;color:#0f172a}
  .table{width:100%;border-collapse:collapse;font-size:14px;background:#fff}
  .table th,.table td{border-bottom:1px solid #dbe5f1;padding:6px 8px;text-align:left}
  .table th{background:#f4f8fd}
  .center{text-align:center}

  /* data-base */
  .dbase{
    margin-top:8px;
    font-size:14px;
    color:#334155;
    opacity:.9;
    text-align:right;
  }

  .col-12{grid-column:span 12}.col-8{grid-column:span 12}.col-4{grid-column:span 12}.col-6{grid-column:span 12}
  @media(min-width:1000px){.col-8{grid-column:span 8}.col-4{grid-column:span 4}.col-6{grid-column:span 6}}
</style>
</head>
<body>
<header>Dashboard FIDC NX Boats</header>

<div class="wrap">
  <div class="grid">
    <!-- PL (com Índice de Subordinação dentro) -->
    <div class="card col-6">
      <div class="band">Patrimônio Líquido (PL)</div>
      <div id="kpiPL" class="kpi-valor">–</div>

      <div class="sub-title">Índice de Subordinação</div>
      <div id="kpiSubInline" class="kpi-valor">–</div>

      <h4 style="margin:12px 0 6px">Composição PL</h4>
      <table class="table" id="tbPL">
        <thead><tr><th>Classe</th><th class="center">Valor</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="dbase" id="dbPL">Data-base: –</div>
    </div>

    <!-- Caixa -->
    <div class="card col-6">
      <div class="band">Caixa</div>
      <div id="kpiCaixa" class="kpi-valor">–</div>

      <h4 style="margin:12px 0 6px">Composição Caixa</h4>
      <table class="table" id="tbCaixa">
        <thead><tr><th>Alocação de Caixa</th><th class="center">Valor</th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="dbase" id="dbCaixa">Data-base: –</div>
    </div>

    <!-- Valor disponível para Risco Sacado -->
    <div class="card col-6">
      <div class="band">Valor Disponível para Risco Sacado</div>
      <div id="kpiRisco" class="kpi-valor center">–</div>
      <div class="dbase" id="dbRisco">Data-base: –</div>
    </div>

    <!-- Principal Alocado (barras) + Share (rosca) -->
    <div class="card col-8">
      <div class="band">Principal Alocado por Operação</div>
      <canvas id="chartPrincipal" height="140"></canvas>
      <div class="dbase" id="dbPrincipal">Data-base: –</div>
    </div>
    <div class="card col-4">
      <div class="band">Share da Carteira</div>
      <canvas id="chartShare" height="140"></canvas>
      <div class="dbase" id="dbShare">Data-base: –</div>
    </div>

    <!-- Valores a Receber + Prazo Médio -->
    <div class="card col-8">
      <div class="band">Valores a Receber por Operação</div>
      <canvas id="chartReceber" height="140"></canvas>
      <div class="dbase" id="dbReceber">Data-base: –</div>
    </div>
    <div class="card col-4">
      <div class="band">Prazo Médio por Operação</div>
      <table class="table">
        <thead><tr><th>Operação</th><th class="center">Dias</th></tr></thead>
        <tbody id="tbodyPrazo"></tbody>
      </table>
      <div class="dbase" id="dbPrazo">Data-base: –</div>
    </div>

    <!-- NOVO: Cronograma de amortização Risco Sacado -->
    <div class="card col-12">
      <div class="band">PL Projetado em Risco Sacado (R$ milhares)</div>
      <canvas id="chartCronRS" height="160"></canvas>
      <div class="dbase" id="dbCronRS">Data-base: –</div>
    </div>
  </div>
</div>

<script>
/* =========================
   CONFIG & helpers
   ========================= */
const DEFAULT_JSON = 'data/carteira_power_bi.json'; // caminho do JSON no seu repo

// Paleta
const C_TOTAL      = '#004065';
const C_CCB        = '#286DAC';
const C_DUP        = '#666666';
const C_RISCO      = '#118DFF';
const C_AZUL_CLARO = '#A7CCEB';

// Moeda completa (sem Mi/mil)
const brlFull = v => (Number(v)||0).toLocaleString('pt-BR',{
  style:'currency', currency:'BRL', minimumFractionDigits:2, maximumFractionDigits:2
});

// Data label abreviada p/ gráficos
function fmt1(n){
  n = Number(n)||0;
  const abs = Math.abs(n);
  if (abs >= 1_000_000)  return (n/1_000_000).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+' Mi';
  if (abs >= 1_000)      return (n/1_000).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+' mil';
  return n.toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1});
}
const pct1 = v => (Number(v)||0).toLocaleString('pt-BR',{style:'percent',minimumFractionDigits:1,maximumFractionDigits:1});

// Converte "2025-11-05T00:00:00.000" -> "05/11" (para eixo) ou "05/11/2025" (datas-base)
function toBRDate(str, short=false){
  if(!str) return '–';
  const d = new Date(str);
  if(!isNaN(d)){
    if(short) return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
    return d.toLocaleDateString('pt-BR');
  }
  return String(str);
}

// Milhares com 1 casa (xx,x)
function toThousands1(n){
  return (Number(n)/1000).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1});
}

let chartPrincipal, chartShare, chartReceber, chartCronRS;

/* Utils de filtro */
function byFiltro(rows, nome){ return rows.filter(r => (r["Filtro"]||"").toLowerCase()===nome.toLowerCase()); }
function totalByFiltro(rows, nome){ const arr=byFiltro(rows, nome); return arr.length? (Number(arr[0]["Valor"])||0): 0; }
function firstDateByFiltro(rows, nome, fallbackNome=null){
  let arr = byFiltro(rows, nome);
  if ((!arr || !arr.length) && fallbackNome) arr = byFiltro(rows, fallbackNome);
  const row = arr.find(r => r['Data Base']) || arr[0];
  return row && row['Data Base'] ? String(row['Data Base']) : null;
}
/* Ordem Duplicatas, CCB, Risco Sacado */
function itensOps(rows, nome){
  const ops = ['Duplicatas','CCB','Risco Sacado'];
  const subset = rows.filter(r => (r["Filtro"]||"").toLowerCase()===nome.toLowerCase());
  return ops.map(op=>{
    const it = subset.find(x => String(x["Overview FIDC NX Boats"]).toLowerCase()===op.toLowerCase());
    return {label: op, valor: it? Number(it["Valor"])||0 : 0};
  });
}

/* =========================
   KPIs + datas
   ========================= */
function setKpis(rows){
  document.getElementById("kpiPL").textContent        = brlFull(totalByFiltro(rows,"Patrimônio Líquido (PL)"));
  document.getElementById("kpiSubInline").textContent = pct1(totalByFiltro(rows,"Índice de Subordinação Total"));
  document.getElementById("kpiCaixa").textContent     = brlFull(totalByFiltro(rows,"(=) Caixa e Disponibilidades"));
  document.getElementById("kpiRisco").textContent     = brlFull(totalByFiltro(rows,"(=) Valor Disponível para Risco Sacado"));

  // Datas próprias
  setDB('dbPL',    firstDateByFiltro(rows,"Patrimônio Líquido (PL)"));
  setDB('dbCaixa', firstDateByFiltro(rows,"(=) Caixa e Disponibilidades"));
  setDB('dbRisco', firstDateByFiltro(rows,"(=) Valor Disponível para Risco Sacado"));

  // Datas “forçadas” a usar Principal Alocado
  const principalDate = firstDateByFiltro(rows,"Principal Alocado Total");
  setDB('dbPrincipal', principalDate);
  setDB('dbShare',     principalDate);
  setDB('dbReceber',   principalDate);
  setDB('dbPrazo',     principalDate);
  setDB('dbCronRS',    principalDate); // novo card segue a mesma lógica
}
function setDB(id, dateStr){
  document.getElementById(id).textContent = `Data-base: ${toBRDate(dateStr)}`;
}

/* =========================
   Gráficos existentes
   ========================= */
function commonBarOptions(maxVal){
  return {
    plugins:{
      legend:{ display:false },
      datalabels:{
        anchor:'end', align:'end',
        formatter:(v)=> 'R$ ' + fmt1(v),
        color:'#000', font:{weight:'700', size:16}
      },
      tooltip:{ callbacks:{ label:(c)=> 'R$ ' + fmt1(c.parsed.y) } }
    },
    layout:{ padding:{ top:20 } },
    scales:{
      x:{ grid:{display:false} },
      y:{
        grid:{display:false},
        ticks:{ display:false },
        beginAtZero:true,
        suggestedMax: maxVal * 1.15
      }
    }
  };
}

function renderPrincipal(rows){
  const partes = itensOps(rows, "Principal Alocado");
  const total  = partes.reduce((a,b)=>a+b.valor,0);
  const labels = ['Total', ...partes.map(x=>x.label)];
  const data   = [total, ...partes.map(x=>x.valor)];
  const colors = [C_TOTAL, C_DUP, C_CCB, C_RISCO];

  const maxVal = Math.max(...data);
  const ctx = document.getElementById('chartPrincipal');
  if(chartPrincipal) chartPrincipal.destroy();
  chartPrincipal = new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ data, backgroundColor: colors }] },
    options: commonBarOptions(maxVal),
    plugins:[ChartDataLabels]
  });
}

function renderShare(rows){
  const partes = itensOps(rows, "Share da Carteira");
  const ctx = document.getElementById('chartShare');
  if(chartShare) chartShare.destroy();
  chartShare = new Chart(ctx,{
    type:'doughnut',
    data:{
      labels: partes.map(x=>x.label),
      datasets:[{ data: partes.map(x=>x.valor), backgroundColor:[C_DUP,C_CCB,C_RISCO] }]
    },
    options:{
      plugins:{
        legend:{ position:'bottom' },
        datalabels:{
          formatter:(v,ctx)=>{
            const total = ctx.dataset.data.reduce((a,b)=>a+b,0);
            const p = total? (v/total) : 0;
            return pct1(p);
          },
          color:'#fff', font:{weight:'700', size:16}
        },
        tooltip:{ callbacks:{ label:(c)=> `${c.label}: ${pct1(c.parsed)}` } }
      }
    },
    plugins:[ChartDataLabels]
  });
}

function renderReceber(rows){
  const partes = itensOps(rows, "Valores a Receber");
  const total  = partes.reduce((a,b)=>a+b.valor,0);
  const labels = ['Total', ...partes.map(x=>x.label)];
  const data   = [total, ...partes.map(x=>x.valor)];
  const colors = [C_TOTAL, C_DUP, C_CCB, C_RISCO];

  const maxVal = Math.max(...data);
  const ctx = document.getElementById('chartReceber');
  if(chartReceber) chartReceber.destroy();
  chartReceber = new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ data, backgroundColor: colors }] },
    options: commonBarOptions(maxVal),
    plugins:[ChartDataLabels]
  });
}

/* =========================
   Prazo Médio (tabela)
   ========================= */
function renderPrazo(rows){
  const totalPrazoRows = byFiltro(rows,"Prazo Médio total");
  const totalPrazo = totalPrazoRows.length ? Number(totalPrazoRows[0]["Valor"])||0 : 0;

  const linhas = [
    {label:'(=) Prazo Médio', valor: totalPrazo},
    ...itensOps(rows,"Prazo Médio").filter(x=>x.label!=='(=) Prazo Médio')
  ];
  const tb = document.getElementById("tbodyPrazo"); tb.innerHTML="";
  linhas.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${r.label}</td><td class="center">${(Number(r.valor)||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`;
    tb.appendChild(tr);
  });
}

/* =========================
   Tabelas de composição
   ========================= */
function renderTabelaPL(rows){
  const labels = [
    {disp:'Cotas Sêniores',  keys:['Cotas Sêniors','Cotas Seniores','Cotas Sêniores']},
    {disp:'Cotas Subordinadas', keys:['Cotas Subordinadas']},
    {disp:'Cotas Mezanino', keys:['Cotas Mezanino','Cotas MezAnino']}
  ];
  const tbody = document.querySelector('#tbPL tbody'); tbody.innerHTML='';
  labels.forEach(l=>{
    const row = rows.find(r =>
      l.keys.map(k=>k.toLowerCase()).includes(String(r['Overview FIDC NX Boats']||'').toLowerCase()) &&
      (!r['Unid'] || String(r['Unid']).toLowerCase().includes('r$'))
    );
    const val = row ? Number(row['Valor'])||0 : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${l.disp}</td><td class="center">${brlFull(val)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderTabelaCaixa(rows){
  const map = [
    {disp:'(+) Liquidez Imediata', keys:['(+) Aplicações Liquidez Imediata','(+) Liquidez Imediata','Liquidez Imediata']},
    {disp:'(+) Kanastra',          keys:['(+) Conta Kanastra (Cobrança)','(+) Kanastra']},
    {disp:'(+) Santander',         keys:['(+) Conta Santander (Zeragem)','(+) Santander']}
  ];
  const tbody = document.querySelector('#tbCaixa tbody'); tbody.innerHTML='';
  map.forEach(l=>{
    const row = rows.find(r =>
      l.keys.map(k=>k.toLowerCase()).includes(String(r['Overview FIDC NX Boats']||'').toLowerCase())
    );
    const val = row ? Number(row['Valor'])||0 : 0;
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${l.disp}</td><td class="center">${brlFull(val)}</td>`;
    tbody.appendChild(tr);
  });
}

/* =========================
   NOVO: Cronograma Risco Sacado (LINHA)
   ========================= */
// Lê 31 linhas após o marcador "Cronograma de amortização Risco Sacado"
// Eixo X: datas em "Overview FIDC NX Boats" | Eixo Y: Principal EoP em "Data Base"
function getCronogramaData(rawRows){
  const rows = rawRows; // usar estrutura crua do JSON
  const idxMarker = rows.findIndex(r => String(r["Overview FIDC NX Boats"]||'').trim().toLowerCase() === 'cronograma de amortização risco sacado');
  if(idxMarker === -1) return {labels:[], values:[]};

  // Próxima linha costuma ser cabeçalho; começamos duas linhas depois
  let start = idxMarker + 2;
  const labels = [];
  const values = [];

  for(let i=0; i<31; i++){
    const row = rows[start + i];
    if(!row) break;

    const labelISO = row["Overview FIDC NX Boats"];
    const eop = row["Data Base"]; // Principal EoP
    if(labelISO == null || eop == null) break;

    labels.push(toBRDate(labelISO, true)); // dd/MM
    values.push(Number(eop) || 0);
  }
  return {labels, values};
}

function renderCronograma(rawRows){
  const {labels, values} = getCronogramaData(rawRows);
  const ctx = document.getElementById('chartCronRS');
  if(chartCronRS) chartCronRS.destroy();

  const lineColor = '#004065';
  const maxVal = values.length ? Math.max(...values) : 0;

  chartCronRS = new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[{
        data: values,
        borderColor: lineColor,
        backgroundColor: lineColor,
        pointBackgroundColor: lineColor,
        pointBorderColor: lineColor,
        pointRadius: 2,
        pointHoverRadius: 4,
        borderWidth: 2,
        tension: 0.25,   // leve suavização
        fill: false
      }]
    },
    options:{
      plugins:{
        legend:{ display:false },
        datalabels:{
          // pill com a mesma cor da linha e texto branco
          backgroundColor: lineColor,
          borderRadius: 6,
          color:'#fff',
          padding:{top:3,right:6,bottom:3,left:6},
          clamp:true,
          clip:true,
          align:'top',
          offset: 6,
          formatter:(v)=> toThousands1(v), // milhares com 1 casa
          display:(ctx)=>{
            const i = ctx.dataIndex;
            const total = ctx.dataset.data.length;
            const last = total - 1;
            // mostra no primeiro, no último e a cada 3 dias
            return (i===0) || (i===last) || (i % 3 === 0);
          }
        },
        tooltip:{
          callbacks:{
            label:(c)=> 'R$ ' + fmt1(c.parsed.y)
          }
        }
      },
      layout:{ padding:{ top:20 } },
      scales:{
        x:{ grid:{ display:false } },
        y:{
          beginAtZero:true,
          grid:{ display:false },
          ticks:{ display:false },
          suggestedMax: maxVal * 1.10
        }
      }
    },
    plugins:[ChartDataLabels]
  });
}

/* =========================
   Normalização e carga
   ========================= */
function normalizeRows(rows){
  return rows.map(r => ({
    "Overview FIDC NX Boats": r["Overview FIDC NX Boats"] ?? r["Overview"] ?? r["Descrição"] ?? r["Descricao"] ?? r["desc"] ?? null,
    "Unid": r["Unid"] ?? r["Unidade"] ?? null,
    "Fonte": r["Fonte"] ?? null,
    "Data Base": r["Data Base"] ?? r["DataBase"] ?? r["Data"] ?? null,
    "Valor": (typeof r["Valor"]==="string") ? Number(r["Valor"].replace(/\./g,'').replace(',','.')) : (r["Valor"]??0),
    "Filtro": r["Filtro"] ?? r["Categoria"] ?? null
  }));
}

function loadDefault(){
  const bust = `?v=${Date.now()}`; // evita cache
  fetch(DEFAULT_JSON + bust)
    .then(r => { if(!r.ok) throw new Error('Falha ao ler JSON'); return r.json(); })
    .then(raw => {
      // Normalizado (para os cards existentes) + Cru (para o cronograma)
      const rowsNorm = normalizeRows(raw);

      setKpis(rowsNorm);
      renderPrincipal(rowsNorm);
      renderShare(rowsNorm);
      renderReceber(rowsNorm);
      renderPrazo(rowsNorm);
      renderTabelaPL(rowsNorm);
      renderTabelaCaixa(rowsNorm);

      // Novo card (linha)
      renderCronograma(raw);
    })
    .catch(err => alert('Erro ao carregar JSON: ' + err.message));
}

Chart.register(ChartDataLabels);
window.addEventListener('DOMContentLoaded', loadDefault);
</script>
</body>
</html>
