<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Dashboard FIDC NX Boats</title>

<!-- Chart.js + DataLabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
  :root{
    --azul-muito-escuro:#004065; /* HEX1 */
    --azul-escuro:#286DAC;       /* HEX2 */
    --azul-claro:#A7CCEB;        /* HEX3 */
    --azul-destaque:#118DFF;     /* HEX4 */
    --cinza-mto-escuro:#666666;  /* HEX5 */
    --verde-ok:#16a34a;
    --vermelho-no:#dc2626;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:#eef4fb;color:#0f172a}
  header{
    background:var(--azul-muito-escuro);
    color:#fff;
    padding:12px 18px;
    font-weight:900;
    font-size:28px;
    text-align:center;
    letter-spacing:.3px
  }
  .wrap{max-width:1200px;margin:18px auto;padding:0 12px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
  .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}
  .band{background:var(--azul-escuro);color:#fff;border-radius:10px;padding:8px 10px;font-weight:900;margin:-6px -6px 12px;letter-spacing:.3px}
  .kpi-valor{font-size:32px;font-weight:900;margin:6px 0;color:#000}
  .kpi-valor.center{text-align:center}
  .sub-title{margin:12px 0 4px;font-weight:800;color:#0f172a}
  .table{width:100%;border-collapse:collapse;font-size:14px;background:#fff}
  .table th,.table td{border-bottom:1px solid #dbe5f1;padding:6px 8px;text-align:left;vertical-align:top}
  .table th{background:#f4f8fd}
  .center{text-align:center}
  .dbase{margin-top:8px;font-size:14px;color:#334155;opacity:.9;text-align:right}
  .obs{margin-top:4px;font-size:14px;color:#334155;opacity:.9;text-align:right}

  .col-12{grid-column:span 12}.col-8{grid-column:span 12}.col-4{grid-column:span 12}.col-6{grid-column:span 12}
  @media(min-width:1000px){.col-8{grid-column:span 8}.col-4{grid-column:span 4}.col-6{grid-column:span 6}}

  /* ========= LOGIN ========= */
  #login{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .login-card{width:100%;max-width:420px;background:#fff;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.08);padding:22px}
  .login-head{display:flex;align-items:center;gap:10px;margin-bottom:10px}
  .badge{background:var(--azul-escuro);color:#fff;padding:8px 12px;border-radius:12px;font-weight:900}
  .login-title{font-size:20px;font-weight:800;margin:6px 0 2px}
  .login-sub{font-size:13px;color:#475569;margin-bottom:16px}
  .login-group{margin:10px 0}
  .login-label{display:block;font-size:13px;font-weight:700;margin-bottom:6px;color:#0f172a}
  .login-input{width:100%;border:1px solid #dbe5f1;border-radius:10px;padding:10px 12px;font-size:15px;outline:none}
  .login-input:focus{border-color:var(--azul-escuro);box-shadow:0 0 0 3px rgba(40,109,172,.15)}
  .login-remember{display:flex;align-items:center;gap:8px;margin:8px 0 2px;font-size:14px;color:#334155}
  .login-error{color:#b91c1c;background:#fee2e2;border:1px solid #fecaca;border-radius:10px;padding:8px 10px;font-size:13px;display:none;margin-top:8px}
  .login-actions{display:flex;gap:10px;margin-top:12px}
  .btn{appearance:none;border:none;border-radius:12px;background:var(--azul-muito-escuro);color:#fff;padding:10px 14px;font-weight:900;cursor:pointer;font-size:15px}
  .btn.sec{background:#e2e8f0;color:#0f172a;font-weight:800}
  .muted{font-size:12px;color:#64748b;margin-top:8px}

  /* ========= TABS ========= */
  #app{display:none}
  .tabs{display:flex;gap:8px;margin:0 auto 12px;max-width:1200px;padding:0 12px}
  .tabbtn{background:#dbe5f1;border:none;border-radius:999px;padding:8px 14px;font-weight:800;color:#0f172a;cursor:pointer}
  .tabbtn.active{background:var(--azul-escuro);color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08)}
  .page{display:none}
  .page.active{display:block}

  /* ========= TABELAS ESPECIAIS (Página 2) ========= */
  .subsec{background:var(--azul-claro);font-weight:900;color:#0f172a}
  .tag-ok{background:rgba(22,163,74,.12);color:var(--verde-ok);padding:2px 8px;border-radius:999px;font-weight:800;display:inline-block}
  .tag-no{background:rgba(220,38,38,.12);color:var(--vermelho-no);padding:2px 8px;border-radius:999px;font-weight:800;display:inline-block}
  .tfoot-note{font-size:13px;color:#334155;opacity:.95;text-align:right;padding-top:6px}
</style>
</head>
<body>

<!-- ====== LOGIN ====== -->
<section id="login" aria-label="Acesso ao Dashboard">
  <div class="login-card">
    <div class="login-head"><span class="badge">Acesso restrito</span></div>
    <div class="login-title">Dashboard FIDC NX Boats</div>
    <div class="login-sub">Informe usuário e senha para visualizar o dashboard.</div>

    <div class="login-group">
      <label class="login-label" for="user">Usuário</label>
      <input id="user" class="login-input" type="text" autocomplete="username">
    </div>
    <div class="login-group">
      <label class="login-label" for="pass">Senha</label>
      <input id="pass" class="login-input" type="password" autocomplete="current-password">
    </div>
    <label class="login-remember">
      <input id="remember" type="checkbox"> Lembrar acesso neste dispositivo
    </label>
    <div id="loginError" class="login-error">Credenciais inválidas. Tente novamente.</div>
    <div class="login-actions">
      <button class="btn" id="btnEnter">Entrar</button>
      <button class="btn sec" id="btnClear">Limpar</button>
    </div>
    <div class="muted">Dica: marque “Lembrar acesso” para não precisar logar por 30 dias neste navegador.</div>
  </div>
</section>

<!-- ====== APP (DASHBOARD) ====== -->
<div id="app">
  <header>Dashboard FIDC NX Boats</header>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tabbtn active" data-target="#page1">Página 1 — Resumo</button>
    <button class="tabbtn" data-target="#page2">Página 2 — Monitoramento, Clientes e Receita</button>
  </div>

  <!-- ===== PAGE 1 (Cessão A) ===== -->
  <section id="page1" class="page active">
    <div class="wrap">
      <div class="grid">

        <!-- PL (com Índice de Subordinação dentro — se houver) -->
        <div class="card col-6">
          <div class="band">Patrimônio Líquido (PL)</div>
          <div id="kpiPL" class="kpi-valor">–</div>
          <div class="sub-title">Índice de Subordinação</div>
          <div id="kpiSubInline" class="kpi-valor">–</div>

          <h4 style="margin:12px 0 6px">Composição PL</h4>
          <table class="table" id="tbPL">
            <thead><tr><th>Classe</th><th class="center">Valor</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="dbase" id="dbPL">Data-base: –</div>
        </div>

        <!-- Caixa -->
        <div class="card col-6">
          <div class="band">Caixa</div>
          <div id="kpiCaixa" class="kpi-valor">–</div>

          <h4 style="margin:12px 0 6px">Composição Caixa</h4>
          <table class="table" id="tbCaixa">
            <thead><tr><th>Alocação de Caixa</th><th class="center">Valor</th></tr></thead>
            <tbody></tbody>
          </table>
          <div class="dbase" id="dbCaixa">Data-base: –</div>
        </div>

        <!-- Principal Alocado (barras) + Share (rosca) -->
        <div class="card col-8">
          <div class="band">Principal Alocado por Operação</div>
          <canvas id="chartPrincipal" height="160"></canvas>
          <div class="dbase" id="dbPrincipal">Data-base: –</div>
          <div class="obs">Considera valor presente atualizado dos DCs</div>
        </div>
        <div class="card col-4">
          <div class="band">Share da Carteira</div>
          <canvas id="chartShare" height="160"></canvas>
          <div class="dbase" id="dbShare">Data-base: –</div>
        </div>

        <!-- Valores a Receber + Prazo Médio -->
        <div class="card col-8">
          <div class="band">Valores a Receber por Operação</div>
          <canvas id="chartReceber" height="160"></canvas>
          <div class="dbase" id="dbReceber">Data-base: –</div>
          <div class="obs">Considera valor presente atualizado dos DCs</div>
        </div>
        <div class="card col-4">
          <div class="band">Prazo Médio por Operação</div>
          <table class="table">
            <thead><tr><th>Operação</th><th class="center">Dias</th></tr></thead>
            <tbody id="tbodyPrazo"></tbody>
          </table>
          <div class="dbase" id="dbPrazo">Data-base: –</div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===== PAGE 2 (B, C, D) ===== -->
  <section id="page2" class="page">
    <div class="wrap grid">
      <!-- Índices de Monitoramento -->
      <div class="card col-12">
        <div class="band">Índices de Monitoramento</div>
        <table class="table" id="tbMonit">
          <thead>
            <tr>
              <th>Indicador</th>
              <th class="center">Unidade</th>
              <th class="center">Data Base</th>
              <th class="center">Valor Atual</th>
              <th class="center">Índice Alvo</th>
              <th class="center">Valor Disponível</th>
              <th>Descrição</th>
              <th class="center">Enquadramento</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Principais Clientes -->
      <div class="card col-12">
        <div class="band">Principais Clientes — Sacados</div>
        <table class="table" id="tbSacados">
          <thead>
            <tr>
              <th>Nome do sacado</th><th class="center">Unidade</th><th class="center">Valor alocado</th><th class="center">Código NX Boats</th><th>Observação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="tfoot-note">Observação: Considera valor presente atualizado dos DCs</div>
      </div>

      <div class="card col-12">
        <div class="band">Principais Clientes — Risco Sacado</div>
        <table class="table" id="tbRiscoSac">
          <thead>
            <tr>
              <th>Nome do Cedente</th><th class="center">Unidade</th><th class="center">Valor alocado</th><th>Observação</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="tfoot-note">Observação: Considera valor presente atualizado dos DCs</div>
      </div>

      <!-- Receita Naval Serviços Financeiros -->
      <div class="card col-12">
        <div class="band">Receita Naval Serviços Financeiros</div>
        <canvas id="chartReceita" height="160"></canvas>
      </div>
    </div>
  </section>
</div>

<script>
/* =========================
   LOGIN / AUTENTICAÇÃO (igual ao seu antigo)
   ========================= */
const USER_EXPECTED = 'fidcnxboats';
const PASS_EXPECTED = 'fidcnxb2025';
const REMEMBER_KEY  = 'nxAuth';
const REMEMBER_TTL  = 30 * 24 * 60 * 60 * 1000; // 30 dias

function rememberNow(){ localStorage.setItem(REMEMBER_KEY, JSON.stringify({ok:true, ts:Date.now()})); }
function isRemembered(){
  try{ const o=JSON.parse(localStorage.getItem(REMEMBER_KEY)||'null'); return o && o.ok && (Date.now()-o.ts)<REMEMBER_TTL; }catch(e){ return false; }
}
function showApp(){ document.getElementById('login').style.display='none'; document.getElementById('app').style.display='block'; bootDashboard(); }
function handleLogin(){
  const u=document.getElementById('user').value.trim();
  const p=document.getElementById('pass').value.trim();
  const remember=document.getElementById('remember').checked;
  const err=document.getElementById('loginError');
  if(u===USER_EXPECTED && p===PASS_EXPECTED){ err.style.display='none'; if(remember) rememberNow(); showApp(); }
  else err.style.display='block';
}
function prepLoginUI(){
  document.getElementById('btnEnter').addEventListener('click', handleLogin);
  document.getElementById('btnClear').addEventListener('click', ()=>{
    document.getElementById('user').value=''; document.getElementById('pass').value=''; document.getElementById('loginError').style.display='none';
  });
  document.getElementById('pass').addEventListener('keydown', e=>{ if(e.key==='Enter') handleLogin(); });
  if(isRemembered()) showApp();
}

/* =========================
   CONSTANTES & HELPERS
   ========================= */
const DEFAULT_JSON = 'data/carteira_power_bi.json';

const C_TOTAL      = '#004065';
const C_CCB        = '#286DAC';
const C_DUP        = '#666666';
const C_RISCO      = '#118DFF';
const C_AZUL_CLARO = '#A7CCEB';

const brlFull = v => (Number(v)||0).toLocaleString('pt-BR',{style:'currency',currency:'BRL',minimumFractionDigits:2,maximumFractionDigits:2});
const brlK    = v => (Number(v)/1000).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1}); // mil
const pct1 = v => (Number(v)||0).toLocaleString('pt-BR',{style:'percent',minimumFractionDigits:1,maximumFractionDigits:1});
function toBRDate(str){ if(!str) return '–'; const d=new Date(str); return isNaN(d)? String(str) : d.toLocaleDateString('pt-BR'); }

/* =========================
   PARSE DO NOVO JSON (1..11)
   ========================= */
function parseNew(rows){
  // Garante objeto com strings "1".."11"
  const norm = rows.map(r=>{
    const out={}; for(let i=1;i<=11;i++) out[i]= r[String(i)] ?? null; return out;
  });

  // Quebra por letra da coluna 2
  const sec = { A:[], a:[], B:[], b:[], C:[], c:[], D:[], d:[] };
  norm.forEach(r=>{
    const k=r[2]; if(k && sec.hasOwnProperty(k)) sec[k].push(r);
  });

  // Helpers por cessão
  const A = {
    rows: sec['a'],
    find: name => sec['a'].find(r => (r[4]||'').trim().toLowerCase() === name.trim().toLowerCase())
  };

  const B = {
    rows: sec['b']
  };

  const C = {
    rows: sec['c']
  };

  const D = {
    rows: sec['d']
  };

  return {A,B,C,D};
}

/* =========================
   TABS
   ========================= */
function setupTabs(){
  document.querySelectorAll('.tabbtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      btn.classList.add('active');
      const target=document.querySelector(btn.dataset.target);
      if(target) target.classList.add('active');
    });
  });
}

/* =========================
   RENDER PAGE 1 (A)
   ========================= */
let chartPrincipal, chartShare, chartReceber;

function renderPage1(sections){
  const {A} = sections;

  // KPIs
  const pl = A.find('Patrimônio Líquido (PL)');
  document.getElementById('kpiPL').textContent = pl? brlFull(pl[7]) : '–';
  document.getElementById('dbPL').textContent  = 'Data-base: ' + toBRDate(pl && pl[6]);

  // Índice de Subordinação (se existir na B, preenche; senão esconde)
  const subNode = document.getElementById('kpiSubInline');
  // tenta coletar da seção B (Índice de Subordinação Cotas Sênior)
  let subVal = null; // se quiser, pode pegar de B depois do parse
  if(subVal==null){
    // esconde linha se indisponível
    subNode.textContent = '–';
  }

  // Caixa
  const cx = A.find('(=) Caixa e Disponibilidades');
  document.getElementById('kpiCaixa').textContent = cx? brlFull(cx[7]) : '–';
  document.getElementById('dbCaixa').textContent  = 'Data-base: ' + toBRDate(cx && cx[6]);

  // Tabelas PL e Caixa
  renderTabelaPL_A(A);
  renderTabelaCaixa_A(A);

  // Principal Alocado (gráfico + balões com/sem AF)
  renderPrincipal_A(A);
  // Share
  renderShare_A(A);
  // Valores a Receber
  renderReceber_A(A);
  // Prazo Médio
  renderPrazo_A(A);
}

function renderTabelaPL_A(A){
  const tbody=document.querySelector('#tbPL tbody'); tbody.innerHTML='';
  const itens=[
    'Cotas Sêniores','Cotas Mezanino','Cotas Subordinadas'
  ];
  itens.forEach(label=>{
    const r=A.find(label); const v=r? Number(r[7])||0 : 0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${label}</td><td class="center">${brlFull(v)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderTabelaCaixa_A(A){
  const tbody=document.querySelector('#tbCaixa tbody'); tbody.innerHTML='';
  const itens=[
    {disp:'(+) Liquidez Imediata', key:'(+) Liquidez Imediata'},
    {disp:'(+) Kanastra', key:'(+) Kanastra'},
    {disp:'(+) Santander', key:'(+) Santander'}
  ];
  itens.forEach(it=>{
    const r=A.find(it.key); const v=r? Number(r[7])||0 : 0;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${it.disp}</td><td class="center">${brlFull(v)}</td>`;
    tbody.appendChild(tr);
  });
}

function renderPrincipal_A(A){
  const dup = A.find('Duplicatas');
  const ccb = A.find('CCB');
  const ris = A.find('Risco Sacado');
  const total = A.find('(=) Principal Alocado');
  const comAF = A.find('com alienação');
  const semAF = A.find('Sem Alienação');

  const labels=['Total','Duplicatas','CCB','Risco Sacado'];
  const data=[
    total? Number(total[7])||0 : 0,
    dup? Number(dup[7])||0 : 0,
    ccb? Number(ccb[7])||0 : 0,
    ris? Number(ris[7])||0 : 0
  ];
  const colors=[C_TOTAL,C_DUP,C_CCB,C_RISCO];

  const dupIndex=labels.indexOf('Duplicatas');

  const ctx=document.getElementById('chartPrincipal');
  if(chartPrincipal) chartPrincipal.destroy();
  chartPrincipal=new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[
      { data, backgroundColor: colors },
      // dataset “pontos” para balões de Com/sem AF posicionados sobre a barra de Duplicatas
      { type:'scatter',
        data:[
          {x: dupIndex, y: data[dupIndex]},
          {x: dupIndex, y: data[dupIndex]}
        ],
        pointRadius:0, // invisível
      }
    ]},
    options:{
      plugins:{
        legend:{display:false},
        datalabels:{
          // labels do dataset 0 (barras)
          formatter:(v,ctx)=>{
            if(ctx.datasetIndex===0) return 'R$ ' + (Number(v)||0).toLocaleString('pt-BR',{maximumFractionDigits:0});
            // dataset de balões
            if(ctx.datasetIndex===1){
              if(ctx.dataIndex===0 && comAF)  return 'Com AF: '  + brlFull(comAF[7]);
              if(ctx.dataIndex===1 && semAF)  return 'Sem AF: '  + brlFull(semAF[7]);
              return null;
            }
          },
          align:(ctx)=> ctx.datasetIndex===0 ? 'end' : 'top',
          anchor:(ctx)=> ctx.datasetIndex===0 ? 'end' : 'end',
          offset:(ctx)=> ctx.datasetIndex===0 ? 0 : (ctx.dataIndex===0 ? -10 : -40),
          backgroundColor:(ctx)=> ctx.datasetIndex===1 ? C_AZUL_CLARO : null,
          color:(ctx)=> ctx.datasetIndex===1 ? '#0f172a' : '#000',
          borderRadius:(ctx)=> ctx.datasetIndex===1 ? 12 : 0,
          padding:(ctx)=> ctx.datasetIndex===1 ? {top:4,right:8,bottom:4,left:8} : 0,
          font:(ctx)=> ctx.datasetIndex===1 ? {weight:'800',size:11} : {weight:'700',size:14},
          clip:false
        },
        tooltip:{ callbacks:{ label:(c)=> 'R$ ' + (Number(c.parsed.y)||0).toLocaleString('pt-BR') } }
      },
      layout:{ padding:{top:20,right:20,left:10} },
      scales:{
        x:{ grid:{display:false} },
        y:{ grid:{display:false}, ticks:{display:false}, beginAtZero:true, suggestedMax: Math.max(...data)*1.15 }
      }
    },
    plugins:[ChartDataLabels]
  });

  document.getElementById('dbPrincipal').textContent = 'Data-base: ' + toBRDate(total && total[6]);
}

function renderShare_A(A){
  const ccb=A.find('CCB'); const dup=A.find('Duplicatas'); const ris=A.find('Risco Sacado');
  const ctx=document.getElementById('chartShare');
  if(chartShare) chartShare.destroy();
  chartShare=new Chart(ctx,{
    type:'doughnut',
    data:{
      labels:['Duplicatas','CCB','Risco Sacado'],
      datasets:[{ data:[dup?dup[7]:0, ccb?ccb[7]:0, ris?ris[7]:0], backgroundColor:[C_DUP,C_CCB,C_RISCO] }]
    },
    options:{
      plugins:{
        legend:{ position:'bottom' },
        datalabels:{
          formatter:(v,ctx)=>{
            const tot=ctx.dataset.data.reduce((a,b)=>a+Number(b||0),0);
            return tot? pct1(v/tot) : '';
          },
          color:'#fff', font:{weight:'700', size:16}
        }
      }
    },
    plugins:[ChartDataLabels]
  });
  // data-base acompanhar “(=) Principal Alocado”
  const total=A.find('(=) Principal Alocado');
  document.getElementById('dbShare').textContent = 'Data-base: ' + toBRDate(total && total[6]);
}

function renderReceber_A(A){
  const tot=A.find('(=) Valores a Receber');
  const ccb=A.find('CCB'); // atenção: existem várias “CCB”; pegaremos a que aparece depois da linha "(=) Valores a Receber"
  // Para simplificar: use os 3 específicos após a linha de "(=) Valores a Receber"
  const idx = A.rows.indexOf(tot);
  let ccbRec, dupRec, risRec;
  if(idx>=0){
    ccbRec = A.rows[idx+1] && (A.rows[idx+1][4]||'').trim().toLowerCase()==='ccb' ? A.rows[idx+1] : null;
    dupRec = A.rows[idx+2] && (A.rows[idx+2][4]||'').trim().toLowerCase()==='duplicatas' ? A.rows[idx+2] : null;
    risRec = A.rows[idx+3] && (A.rows[idx+3][4]||'').trim().toLowerCase()==='risco sacado' ? A.rows[idx+3] : null;
  }
  const labels=['Total','Duplicatas','CCB','Risco Sacado'];
  const data=[
    tot? Number(tot[7])||0 : 0,
    dupRec? Number(dupRec[7])||0 : 0,
    ccbRec? Number(ccbRec[7])||0 : 0,
    risRec? Number(risRec[7])||0 : 0
  ];
  const ctx=document.getElementById('chartReceber');
  if(chartReceber) chartReceber.destroy();
  chartReceber=new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ data, backgroundColor:[C_TOTAL,C_DUP,C_CCB,C_RISCO] }] },
    options:{
      plugins:{
        legend:{display:false},
        datalabels:{ anchor:'end', align:'end', formatter:(v)=> 'R$ ' + (Number(v)||0).toLocaleString('pt-BR'), color:'#000', font:{weight:'700',size:14} },
        tooltip:{ callbacks:{ label:(c)=> 'R$ ' + (Number(c.parsed.y)||0).toLocaleString('pt-BR') } }
      },
      layout:{ padding:{ top:20 } },
      scales:{ x:{grid:{display:false}}, y:{grid:{display:false}, ticks:{display:false}, beginAtZero:true, suggestedMax: Math.max(...data)*1.15 } }
    },
    plugins:[ChartDataLabels]
  });
  document.getElementById('dbReceber').textContent='Data-base: ' + toBRDate(tot && tot[6]);
}

function renderPrazo_A(A){
  // Total + CCB + Duplicatas + Risco Sacado (em dias)
  const total = A.find('(=) Prazo Médio ');
  const ccb   = A.find('CCB');
  const dup   = A.find('Duplicatas');
  const ris   = A.find('Risco Sacado');

  const linhas=[
    {label:'(=) Prazo Médio', valor: total? Number(total[7])||0 : 0},
    {label:'Duplicatas', valor: dup? Number(dup[7])||0 : 0},
    {label:'CCB', valor: ccb? Number(ccb[7])||0 : 0},
    {label:'Risco Sacado', valor: ris? Number(ris[7])||0 : 0},
  ];
  const tb=document.getElementById('tbodyPrazo'); tb.innerHTML='';
  linhas.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.label}</td><td class="center">${(Number(r.valor)||0).toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})}</td>`;
    tb.appendChild(tr);
  });
  document.getElementById('dbPrazo').textContent='Data-base: ' + toBRDate(total && total[6]);
}

/* =========================
   RENDER PAGE 2 (B, C, D)
   ========================= */
function renderPage2(sections){
  renderMonit_B(sections.B);
  renderClientes_C(sections.C);
  renderReceita_D(sections.D);
}

function renderMonit_B(B){
  const tbody=document.querySelector('#tbMonit tbody'); tbody.innerHTML='';

  const rows=B.rows||[];

  // Percorre e escreve blocos com linhas de título (Subordinação, Alocação, Por Operação, Por Sacado, Inadimplência)
  const isTitle = v => ['Subordinação','Alocação','Por Operação','Por Sacado','Inadimplência'].includes((v||'').trim());

  rows.forEach(r=>{
    const nome=(r[4]||'').trim();
    if(!nome) return;

    if(isTitle(nome)){
      const tr=document.createElement('tr');
      tr.className='subsec';
      tr.innerHTML=`<td colspan="8">${nome}</td>`;
      tbody.appendChild(tr);
      return;
    }

    // Linhas de indicador
    const unidade = r[5]||'';
    const dataB   = r[6] ? toBRDate(r[6]) : '';
    const valAt   = r[7]!=null ? r[5]==='%' ? pct1(r[7]) : brlFull(r[7]) : '';
    const alvo    = r[8]!=null ? (r[5]==='%' ? pct1(r[8]) : brlFull(r[8])) : '';
    const disp    = r[9]!=null ? brlFull(r[9]) : '';
    const desc    = r[10]||'';
    const enqua   = (r[11]||'').toString().trim().toUpperCase();

    const tag = enqua==='DESENQUADRADO'
      ? `<span class="tag-no">DESENQUADRADO</span>`
      : (enqua==='OK' ? `<span class="tag-ok">OK</span>` : '');

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${nome}</td>
      <td class="center">${unidade||''}</td>
      <td class="center">${dataB}</td>
      <td class="center">${valAt}</td>
      <td class="center">${alvo}</td>
      <td class="center">${disp}</td>
      <td>${desc}</td>
      <td class="center">${tag}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderClientes_C(C){
  // Sacados
  const sacHeaderIdx = C.rows.findIndex(r => (r[4]||'').trim().toLowerCase()==='sacados');
  const riscoHeaderIdx = C.rows.findIndex(r => (r[4]||'').trim().toLowerCase()==='risco sacado');

  const sacRows = [];
  for(let i=sacHeaderIdx+1; i<C.rows.length; i++){
    const r=C.rows[i]; const nome=(r[4]||'').trim();
    if(!nome || (r[4] && ['risco sacado'].includes(nome.toLowerCase()))) break;
    if(r[5]==null && r[6]==null && r[7]==null) continue;
    sacRows.push(r);
  }

  const riscoRows = [];
  if(riscoHeaderIdx>=0){
    for(let i=riscoHeaderIdx+1; i<C.rows.length; i++){
      const r=C.rows[i]; const nome=(r[4]||'').trim();
      if(!nome) break;
      riscoRows.push(r);
    }
  }

  const tbS=document.querySelector('#tbSacados tbody'); tbS.innerHTML='';
  sacRows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${(r[4]||'').trim()}</td>
      <td class="center">${r[6]||''}</td>
      <td class="center">${brlFull(r[5])}</td>
      <td class="center">${r[7]||''}</td>
      <td>${r[8]||''}</td>
    `;
    tbS.appendChild(tr);
  });

  const tbR=document.querySelector('#tbRiscoSac tbody'); tbR.innerHTML='';
  riscoRows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${(r[4]||'').trim()}</td>
      <td class="center">${r[6]||''}</td>
      <td class="center">${brlFull(r[5])}</td>
      <td>${r[8]||''}</td>
    `;
    tbR.appendChild(tr);
  });
}

let chartReceita;
function renderReceita_D(D){
  const rows = (D.rows||[]).filter(r => r[4] && r[7]!=null); // mês/ano + valor
  const labels = rows.map(r => (r[4]||'').trim());
  const data   = rows.map(r => Number(r[7])||0);

  const ctx=document.getElementById('chartReceita');
  if(chartReceita) chartReceita.destroy();
  chartReceita = new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{ data: data.map(v=>v/1000), backgroundColor: C_AZUL_CLARO, borderColor: C_AZUL_CLARO }] },
    options:{
      plugins:{
        legend:{display:false},
        datalabels:{
          formatter:(v)=> v.toLocaleString('pt-BR',{minimumFractionDigits:1,maximumFractionDigits:1})+' mil',
          anchor:'end', align:'end', color:'#000', font:{weight:'800',size:12}
        },
        tooltip:{ callbacks:{ label:(c)=> 'R$ ' + (Number(c.raw)*1000).toLocaleString('pt-BR') } }
      },
      scales:{
        x:{ grid:{display:false} },
        y:{ grid:{display:false}, ticks:{ display:false }, beginAtZero:true, suggestedMax: Math.max(...data)/1000 * 1.25 }
      },
      layout:{ padding:{ top:20 } }
    },
    plugins:[ChartDataLabels]
  });
}

/* =========================
   LOAD
   ========================= */
function bootDashboard(){
  setupTabs();

  const bust=`?v=${Date.now()}`;
  fetch(DEFAULT_JSON + bust)
    .then(r=>{ if(!r.ok) throw new Error('Falha ao ler JSON'); return r.json(); })
    .then(raw=>{
      const sections=parseNew(raw);
      renderPage1(sections);
      renderPage2(sections);
    })
    .catch(err=> alert('Erro ao carregar JSON: ' + err.message));
}

Chart.register(ChartDataLabels);
window.addEventListener('DOMContentLoaded', prepLoginUI);
</script>
</body>
</html>
